# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Build with Maven
        run: |
          echo "Branch details --" ${GITHUB_REF}
          mvn -B clean package --file pom.xml

      - name: Sonar Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=com.techlearning:demoApp
            -Dsonar.organization=worktobedone
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      - name: Fetch Sonar Coverage
        id: sonar
        run: |
          RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/measures/component?component=com.techlearning:demoApp&metricKeys=coverage,lines_to_cover,uncovered_lines")

          COVERAGE=$(echo $RESPONSE | jq -r '.component.measures[] | select(.metric=="coverage") | .value')
          LINES=$(echo $RESPONSE | jq -r '.component.measures[] | select(.metric=="lines_to_cover") | .value')
          UNCOVERED=$(echo $RESPONSE | jq -r '.component.measures[] | select(.metric=="uncovered_lines") | .value')

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "uncovered=$UNCOVERED" >> $GITHUB_OUTPUT

      - name: Sonar Coverage Summary
        run: |
          echo "## ðŸ“Š Sonar Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | **${{ steps.sonar.outputs.coverage }}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines to cover | ${{ steps.sonar.outputs.lines }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uncovered lines | ${{ steps.sonar.outputs.uncovered }} |" >> $GITHUB_STEP_SUMMARY

      - name: Coverage Badge
        run: |
          COV=${{ steps.sonar.outputs.coverage }}
          if (( $(echo "$COV >= 80" | bc -l) )); then
            ICON="ðŸŸ¢"
          elif (( $(echo "$COV >= 60" | bc -l) )); then
            ICON="ðŸŸ¡"
          else
            ICON="ðŸ”´"
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Status:** $ICON $COV%" >> $GITHUB_STEP_SUMMARY

#      - name: Publish to GitHub Packages Apache Maven
#        run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml
#        env:
#          GITHUB_TOKEN: ${{ github.token }}
